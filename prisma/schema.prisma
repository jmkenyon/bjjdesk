// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  hashedPassword String?
  emailVerified  DateTime?

  firstName   String?
  lastName    String?
  gender      Gender?
  phone       String?
  dateOfBirth String?

  street   String?
  city     String?
  postCode String?
  county   String?
  country  String?

  contactName   String?
  contactNumber String?
  relationship  String?

  hasUsedFreeTrial Boolean    @default(false)
  type             AccessType

  role UserRole
  belt Belt?

  membershipId String?     @db.ObjectId
  membership   Membership? @relation(fields: [membershipId], references: [id])

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  signedWaivers SignedWaiver[]
  accessPasses  AccessPass[]
}

model AccessPass {
  id     String     @id @default(auto()) @map("_id") @db.ObjectId
  type   AccessType
  usedAt DateTime   @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])
}

enum AccessType {
  FREE_TRIAL
  DROP_IN
  MEMBERSHIP
}

enum UserRole {
  ADMIN
  STUDENT
}

enum Belt {
  WHITE
  BLUE
  PURPLE
  BROWN
  BLACK
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

model Gym {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  slug      String    @unique
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  about     String?
  address   String?
  currency  Currency?
  freeTrial Boolean?

  users         User[]
  waiver        Waiver?
  dropIn        DropIn?
  membership    Membership[]
  classes       Class[]
  signedWaivers SignedWaiver[]
  accessPasses  AccessPass[]
}

model Waiver {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  updatedAt DateTime @updatedAt

  gymId         String         @unique @db.ObjectId
  gym           Gym            @relation(fields: [gymId], references: [id])
  signedWaivers SignedWaiver[]
}

model SignedWaiver {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  waiverText String
  signature  String
  signedAt   DateTime @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  waiverId String @db.ObjectId
  waiver   Waiver @relation(fields: [waiverId], references: [id])

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  @@unique([userId, waiverId])
  @@index([userId, gymId])
}

model DropIn {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  fee       Int?
  qrCode    String?

  gymId String @unique @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])
}

model Membership {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  price       Int
  title       String
  description String?

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])
  users User[]
}

model Class {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  dayOfWeek DayOfWeek
  startTime String
  duration  Int

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum Currency {
  USD
  GBP
  EUR
}
